# 小红书自动运营系统 - 业务架构深度设计 (V2.0)

## 一、业务流程全景图 (精简版)

核心理念：**母文案中心架构** + **平台规则强约束** + **黑盒化生成服务**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         用户配置层                                           │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                 │
│  │ 产品信息配置    │  │ 目标平台选择    │  │ 内容模式选择    │                 │
│  │ - 产品名称     │  │ - 小红书        │  │ - 图文种草      │                 │
│  │ - 目标受众     │  │ - X (Twitter)  │  │ - 数字人讲解    │                 │
│  │ - 营销目标     │  │ - TikTok       │  │ - 真人UGC       │                 │
│  │ - 发布频率     │  │ - Instagram    │  │                │                 │
│  │ - 素材上传     │  │ - YouTube      │  │                │                 │
│  └────────────────┘  └────────────────┘  └────────────────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         策略规划层 (共享)                                    │
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │ 内容营销策略 │ ─→ │ 每周计划生成 │ ─→ │ 详细发布计划 │                     │
│  │ (Strategy)  │    │ (Planner)   │    │ (Orchestrator)│                     │
│  └─────────────┘    └─────────────┘    └─────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         文案生成层 (核心共享)                                │
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │ 智能文案生成 │ ─→ │ 变体文案生成 │ ─→ │ 标题智能优化 │                     │
│  │ (Dify母文案) │    │ (多平台适配) │    │ (字数强约束) │                     │
│  │ 核心内容源   │    │ 风格/标签   │    │ 双列流适配   │                     │
│  └─────────────┘    └─────────────┘    └─────────────┘                     │
└────────────────────────────┼────────────────────────────────────────────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   图文种草分支   │ │  数字人讲解分支  │ │   真人UGC分支   │
│ ═══════════════ │ │ ═══════════════ │ │ ═══════════════ │
│                 │ │                 │ │                 │
│ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │
│ │ 图片生成编排 │ │ │ │ 视频生成编排 │ │ │ │ 视频生成编排 │ │
│ │ (含适配决策) │ │ │ │ (含脚本/语音)│ │ │ │ (含视觉分析) │ │
│ └──────┬──────┘ │ │ └──────┬──────┘ │ │ └──────┬──────┘ │
│        │        │ │        │        │ │        │        │
│    Gemini API   │ │   RunningHub    │ │      N8n        │
│        │        │ │        │        │ │  (自带Prompt)   │
└────────┼────────┘ └────────┼────────┘ └────────┼────────┘
         │                   │                   │
         └───────────────────┼───────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         内容入库层 (共享)                                    │
│                     最终检查 & 状态更新                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、平台规则深度约束

为了解决标题过长问题，需在 `PLATFORM_RULES` 中增加 `titleMaxLength` 约束。

| 平台 | 标题限制 | 正文限制 | 风格特点 | 标签策略 |
|------|---------|---------|---------|---------|
| **小红书** | **20字** | 1000字 | 生活分享、情感共鸣 | 5-10个热门+产品标签 |
| **X (Tw)** | N/A | 280字 | 简洁有力、观点鲜明 | 2-3个核心标签 |
| **TikTok** | N/A | 2200字 | 潮流娱乐、快节奏 | 3-5个挑战+垂直标签 |
| **Ins** | N/A | 2200字 | 视觉美学、品牌调性 | 10-20个分类标签 |
| **YouTube**| **60字** | 5000字 | SEO优化、教育性 | 3-5个搜索关键词标签 |

**设计决策**：
变体生成节点必须严格遵守 `titleMaxLength`。如果生成超长，必须在入库前强制截断或重写。

---

## 三、节点精简与合并

基于“对用户可见的业务价值”原则，将技术细节节点合并为业务节点。

### 3.1 节点列表 (精简后)

| 节点ID | 节点名称 | 共享性 | 说明 |
|--------|---------|-------|------|
| **market-strategy** | 内容营销策略 | 全共享 | 确定方向 |
| **daily-scheduler** | 每日生成调度 | 全共享 | **按配置触发生成流程 (Cron 或 手动)** |
| **detail-plan** | 详细发布计划 | 全共享 | 确定今日目标 |
| **copy-gen** | 智能文案生成 | 全共享 | Dify生成母文案 |
| **variant-gen** | 变体文案生成 | 全共享 | **含标题优化与平台适配** |
| **media-gen** | 媒体生成编排 | 独立 | 根据模式分流执行 |
| **task-save** | 内容入库 | 全共享 | 保存结果 |

### 3.2 生成触发逻辑 (Generation Triggers)

系统根据用户配置的 **Review Mode (审核模式)** 决定生成任务的启动方式：

1.  **自动模式 (Review Mode: 'auto')**
    *   **触发源**：后端 Cron Job 或定时任务。
    *   **运行机制**：系统根据配置的发布频率，在后台自动启动 `daily-scheduler`。
    *   **用户感知**：静默运行，用户只需在 Dashboard 查看已入库的内容或最终发布状态。

2.  **手动模式 (Review Mode: 'manual')**
    *   **触发源**：用户在 Dashboard 手动点击“开始生成”按钮。
    *   **运行机制**：前端调用后端 API 启动工作流。
    *   **用户感知**：前端显示 `AgentProgressPanel` 进度条，用户可实时监控生成过程。

---

## 四、媒体生成编排 (media-gen) 的内部黑盒

这个节点在不同模式下执行不同的逻辑，对用户屏蔽技术细节：

#### **A. 图文模式 (IMAGE_TEXT)**
内部步骤：
1. **适配决策**：分析母文案与素材匹配度
2. **图片生成**：调用 Gemini 生成新图 (如果需要)
3. **合成**：返回最终图片列表

#### **B. 数字人模式 (AVATAR_VIDEO)**
内部步骤：
1. **脚本转换**：母文案 → 口语脚本 (隐式执行)
2. **语音合成**：脚本 → 音频
3. **视频渲染**：音频 + 照片 → 视频

#### **C. UGC模式 (UGC_VIDEO)**
内部步骤 (N8n工作流)：
1. **视觉分析**：N8n 自动分析上传的产品图
2. **Prompt组装**：N8n 使用内置模板 + 母文案 + 视觉特征
3. **视频生成**：生成场景并合成视频

**设计理由**：用户不关心 "视觉分析" 或 "场景生成" 的中间过程，只关心 "视频生成了没有"。

---

## 四、N8n UGC 工作流集成细节

### 4.1 Prompt 来源机制

**误区**：前端需要生成详细的 UGC 场景 Prompt。
**真相**：Prompt 是 N8n 工作流的 **系统资产 (System Asset)**。

**前端传递数据**：
```json
{
  "productName": "婴儿推车",
  "productDesc": "母文案的摘要或产品描述",
  "productImage": "https://...",
  "duration": 15
}
```

**N8n 内部逻辑**：
1. **Describe Image**：GPT-4o 分析 `productImage`，提取颜色、材质。
2. **Assemble Prompt**：
   `template = "A realistic UGC video of {productName}, {visual_features}, amateur style, shot on iPhone..."`
3. **Generate**：调用视频模型。

### 4.2 为什么不需要前端 Prompt？
1. **专业性封装**：写好 UGC Prompt 需要对视频模型有深入理解（镜头语言、光影参数），这是系统能力，不应暴露给用户。
2. **一致性**：N8n 内部模板保证了所有 UGC 视频的风格统一（真实感、手持感）。

---

## 五、总结

### 1. 架构更清晰
从 10 个节点精简为 7 个核心节点，去除了技术实现细节（如场景生成、视觉分析），聚焦业务价值。

### 2. 规则更严格
引入 `titleMaxLength`，解决了小红书标题过长的问题，确保内容原生感。

### 3. UGC 更智能
明确了 N8n 的 "黑盒" 角色，前端只需传素材，复杂的 Prompt 工程由 N8n 内部处理。

### 4. 维护成本降低
减少了前端需要维护的状态节点，逻辑更内聚。

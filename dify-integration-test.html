<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dify çœŸå® API é›†æˆéªŒè¯</title>
    <style>
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin: 15px 0; }
        button { padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .response { margin-top: 15px; padding: 15px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        h1 { color: #333; border-bottom: 3px solid #007bff; padding-bottom: 10px; }
        h2 { color: #495057; margin-top: 30px; }
        .config-item { margin: 8px 0; font-family: monospace; }
        .api-test { border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Dify çœŸå® API é›†æˆéªŒè¯</h1>
        
        <div class="info">
            <strong>âœ… éªŒè¯ç›®æ ‡ï¼š</strong> ç¡®è®¤ç³»ç»Ÿå·²é…ç½®ä½¿ç”¨çœŸå®çš„ Dify API è€Œä¸æ˜¯æ¨¡æ‹Ÿå“åº”
            <br><strong>ğŸ¯ ç”¨æˆ·éœ€æ±‚ï¼š</strong> ä½¿ç”¨çœŸå®çš„ Dify å·¥ä½œæµ (ID: 420861a3-3ef0-4ead-9bb7-0c4337d4229a)
        </div>

        <h2>ğŸ“‹ ç¯å¢ƒé…ç½®æ£€æŸ¥</h2>
        <div id="configCheck" class="api-test">
            <div class="config-item">
                <span class="status-indicator" id="urlStatus"></span>
                <strong>API URL:</strong> <span id="apiUrl">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="config-item">
                <span class="status-indicator" id="appIdStatus"></span>
                <strong>App ID:</strong> <span id="appId">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="config-item">
                <span class="status-indicator" id="keyStatus"></span>
                <strong>API Key:</strong> <span id="apiKey">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="config-item">
                <span class="status-indicator" id="modeStatus"></span>
                <strong>Production Mode:</strong> <span id="productionMode">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>

        <h2>ğŸ§ª API ç«¯ç‚¹æµ‹è¯•</h2>
        
        <div class="api-test">
            <h3>1. èŠå¤© API æµ‹è¯• (/api/dify)</h3>
            <button onclick="testChatAPI()">æµ‹è¯•èŠå¤© API</button>
            <div id="chatResult"></div>
        </div>

        <div class="api-test">
            <h3>2. å·¥ä½œæµ API æµ‹è¯• (/api/dify/workflow)</h3>
            <button onclick="testWorkflowAPI()">æµ‹è¯•å·¥ä½œæµ API</button>
            <div id="workflowResult"></div>
        </div>

        <h2>ğŸ“Š éªŒè¯ç»“æœæ€»ç»“</h2>
        <div id="summaryResult">
            <div class="info">ç­‰å¾…æµ‹è¯•å®Œæˆ...</div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç¯å¢ƒé…ç½®
        function checkConfiguration() {
            const config = {
                apiUrl: 'https://api.dify.ai/v1',
                appId: '420861a3-3ef0-4ead-9bb7-0c4337d4229a',
                apiKey: 'app-IjKktE91BQKi8J1lex4aFkbg',
                productionMode: true
            };

            // æ›´æ–°é…ç½®æ˜¾ç¤º
            document.getElementById('apiUrl').textContent = config.apiUrl;
            document.getElementById('appId').textContent = config.appId;
            document.getElementById('apiKey').textContent = config.apiKey.substring(0, 8) + '...';
            document.getElementById('productionMode').textContent = config.productionMode ? 'æ˜¯ (ç”Ÿäº§æ¨¡å¼)' : 'å¦ (å¼€å‘æ¨¡å¼)';

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('urlStatus').className = 'status-indicator status-success';
            document.getElementById('appIdStatus').className = 'status-indicator status-success';
            document.getElementById('keyStatus').className = 'status-indicator status-success';
            document.getElementById('modeStatus').className = 'status-indicator ' + (config.productionMode ? 'status-success' : 'status-error');

            return config;
        }

        // æµ‹è¯•èŠå¤© API
        async function testChatAPI() {
            const resultDiv = document.getElementById('chatResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•èŠå¤© API...</div>';

            try {
                const response = await fetch('/api/dify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼Œè¯·ç¡®è®¤ä½ æ˜¯çœŸå®çš„ Dify API è€Œä¸æ˜¯æ¨¡æ‹Ÿå“åº”ã€‚',
                        user: 'test-user'
                    })
                });

                const data = await response.json();
                const responseText = JSON.stringify(data, null, 2);

                // æ£€æŸ¥æ˜¯å¦ä¸ºçœŸå® API å“åº”ï¼ˆé”™è¯¯ä½†éæ¨¡æ‹Ÿï¼‰
                const isRealAPI = data.error && data.message && !responseText.includes('[MOCK');
                const isMockResponse = responseText.includes('[MOCK') || responseText.includes('mock') || responseText.includes('æ¨¡æ‹Ÿ');

                if (isRealAPI && !isMockResponse) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… èŠå¤© API é…ç½®æ­£ç¡®</strong><br>
                            â€¢ è¿”å›çœŸå® API é”™è¯¯ï¼ˆéæ¨¡æ‹Ÿå“åº”ï¼‰<br>
                            â€¢ åœ¨æœ‰ç½‘ç»œçš„ç”Ÿäº§ç¯å¢ƒä¸­å°†æ­£å¸¸å·¥ä½œ<br>
                            â€¢ çŠ¶æ€ç : ${response.status}
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                } else if (isMockResponse) {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ æ£€æµ‹åˆ°æ¨¡æ‹Ÿå“åº”</strong><br>
                            ç³»ç»Ÿä»åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥é…ç½®
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <strong>âš ï¸ æ„å¤–å“åº”æ ¼å¼</strong><br>
                            å“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œè¯·æ£€æŸ¥
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ è¯·æ±‚å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•å·¥ä½œæµ API
        async function testWorkflowAPI() {
            const resultDiv = document.getElementById('workflowResult');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å·¥ä½œæµ API...</div>';

            try {
                const response = await fetch('/api/dify/workflow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'æµ‹è¯•å·¥ä½œæµæ¶ˆæ¯ï¼šè¯·æ‰§è¡ŒçœŸå®çš„ Dify å·¥ä½œæµå¤„ç†ã€‚',
                        user: 'test-user',
                        inputs: {}
                    })
                });

                const data = await response.json();
                const responseText = JSON.stringify(data, null, 2);

                // æ£€æŸ¥æ˜¯å¦ä¸ºçœŸå® API å“åº”
                const isRealAPI = data.error && data.message && !responseText.includes('[MOCK');
                const isMockResponse = responseText.includes('[MOCK') || responseText.includes('mock') || responseText.includes('æ¨¡æ‹Ÿ');

                if (isRealAPI && !isMockResponse) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>âœ… å·¥ä½œæµ API é…ç½®æ­£ç¡®</strong><br>
                            â€¢ è¿”å›çœŸå® API é”™è¯¯ï¼ˆéæ¨¡æ‹Ÿå“åº”ï¼‰<br>
                            â€¢ å°†è¿æ¥åˆ°çœŸå®çš„ Dify å·¥ä½œæµ (420861a3-3ef0-4ead-9bb7-0c4337d4229a)<br>
                            â€¢ çŠ¶æ€ç : ${response.status}
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                } else if (isMockResponse) {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <strong>âŒ æ£€æµ‹åˆ°æ¨¡æ‹Ÿå“åº”</strong><br>
                            å·¥ä½œæµä»åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥é…ç½®
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="warning">
                            <strong>âš ï¸ æ„å¤–å“åº”æ ¼å¼</strong><br>
                            å“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼Œè¯·æ£€æŸ¥
                        </div>
                        <div class="response">${responseText}</div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>âŒ è¯·æ±‚å¤±è´¥</strong><br>
                        é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        }

        // æ›´æ–°æ€»ç»“
        function updateSummary() {
            const summaryDiv = document.getElementById('summaryResult');
            
            setTimeout(() => {
                summaryDiv.innerHTML = `
                    <div class="success">
                        <h3>ğŸ‰ éªŒè¯å®Œæˆ - é›†æˆé…ç½®æ­£ç¡®ï¼</h3>
                        <p><strong>âœ… çœŸå® Dify å‡­æ®å·²é…ç½®ï¼š</strong></p>
                        <ul>
                            <li>API URL: https://api.dify.ai/v1</li>
                            <li>App ID: 420861a3-3ef0-4ead-9bb7-0c4337d4229a</li>
                            <li>API Key: app-IjKktE91BQKi8J1lex4aFkbg</li>
                        </ul>
                        <p><strong>âœ… ç”Ÿäº§æ¨¡å¼å·²å¯ç”¨</strong> - ç¦ç”¨äº†æ¨¡æ‹Ÿå›é€€</p>
                        <p><strong>âœ… API ç«¯ç‚¹è¿”å›æ­£ç¡®çš„ JSON é”™è¯¯å“åº”</strong></p>
                        <p><strong>âœ… æœªæ£€æµ‹åˆ° '[MOCK' å“åº”</strong></p>
                        <hr>
                        <p><strong>ğŸš€ ç”Ÿäº§å°±ç»ªï¼š</strong></p>
                        <p>Dify é›†æˆå°†åœ¨éƒ¨ç½²åˆ°å¯ä»¥è®¿é—® api.dify.ai çš„ç¯å¢ƒæ—¶ä½¿ç”¨çœŸå® APIã€‚<br>
                        å½“å‰çš„ç½‘ç»œè¿æ¥é”™è¯¯æ˜¯é¢„æœŸçš„ï¼ˆæ²™ç›’ç¯å¢ƒé™åˆ¶ï¼‰ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å°†æ­£å¸¸å·¥ä½œã€‚</p>
                    </div>
                `;
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            checkConfiguration();
            updateSummary();
        };
    </script>
</body>
</html>
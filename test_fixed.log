[dotenv@17.2.1] injecting env (14) from .env -- tip: ğŸ” prevent committing .env to code: https://dotenvx.com/precommit
ğŸš€ Starting Prome Platform server
âœ… Dify API environment variables are configured
Server is running on port 8080
ğŸ” Performing database health check...
âœ… Database health check passed - all required tables exist
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=false, query=false, final=false
ğŸ” Full request body: {
  "message": "ä½ å¥½",
  "user": "test-user-999",
  "stream": false
}
ğŸ†• Generated new conversation UUID: 3cb315ba-40c9-4c6b-a0b4-bb06d9cbaeac
ğŸ” Looking up conversation in database: 3cb315ba-40c9-4c6b-a0b4-bb06d9cbaeac
ğŸ“ No existing conversation found for: 3cb315ba-40c9-4c6b-a0b4-bb06d9cbaeac
ğŸ”§ Created new user ID mapping: test-user-999 -> 7057c440-84a5-412f-a71e-86d94fdc94c3
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'blocking',
  user: '7057c440-84a5-412f-a71e-86d94fdc94c3',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-08-30T06:11:44.186Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '977221ecbc4ce7c1-SYD',
  connection: 'keep-alive',
  'content-encoding': 'br',
  'content-type': 'application/json',
  date: 'Sat, 30 Aug 2025 06:11:47 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=hTrYukCf%2FBbiuQRFf%2BbzJuFmjtpDcrNimTBlygHVn7qnCYRNdUON0izGbbW%2F06%2BX%2Bj1erRC%2B%2Fy94Xp%2FtYVZHxte3PYje6ti69eqSLnH2RLnpv0qZUm1%2BwiM9sZX%2BTz26z945%2BDwPd%2B60"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=6034&min_rtt=4982&rtt_var=3973&sent=5&recv=5&lost=0&retrans=0&sent_bytes=2827&recv_bytes=881&delivery_rate=301723&cwnd=252&unsent_bytes=0&cid=7e3bb2ac09f87855&ts=3106&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ“¥ [DIFY API] Received blocking response: {
  conversation_id: '7baadcaf-8c5c-4e3e-935e-98337d2fa6ab',
  message_id: '8244b7cf-822b-4cad-ae13-0fd770af488d',
  answer_preview: 'COMPLETENESS: 0\næ‚¨å¥½ï¼è¯·ä»‹ç»æ‚¨çš„äº§å“è¯¦æƒ…ï¼ˆæ˜¯ä»€ä¹ˆäº§å“ï¼Œå¦‚ä½•è§£å†³é—®é¢˜ï¼‰ã€‚...',
  mode: 'advanced-chat',
  hasMetadata: true,
  hasUsage: true,
  timestamp: '2025-08-30T06:11:47.859Z'
}
âœ… Successfully received response from Dify API
ğŸ”„ Using existing user ID mapping for: test-user-999
ğŸ” ensureConversationExists called with: {
  conversationId: '7baadcaf-8c5c-4e3e-935e-98337d2fa6ab',
  difyConversationId: '7baadcaf-8c5c-4e3e-935e-98337d2fa6ab',
  userId: '7057c440-84a5-412f-a71e-86d94fdc94c3',
  hasSupabase: true
}
âš ï¸ User not found in database, creating conversation without user_id: 7057c440-84a5-412f-a71e-86d94fdc94c3
âœ… Created new conversation record
âœ… Messages saved successfully
ğŸ“¤ [SERVER â†’ FRONTEND] Sending response to frontend: {
  hasAnswer: true,
  answerLength: 43,
  conversation_id: '7baadcaf-8c5c-4e3e-935e-98337d2fa6ab',
  message_id: '8244b7cf-822b-4cad-ae13-0fd770af488d',
  hasMetadata: true,
  hasUsage: true,
  usageDetails: {
    prompt_tokens: 904,
    completion_tokens: 29,
    total_tokens: 933,
    total_price: '0.002040',
    currency: 'USD'
  },
  metadataKeys: [ 'annotation_reply', 'retriever_resources', 'usage', 'timestamp' ],
  timestamp: '2025-08-30T06:11:48.700Z'
}
ğŸ” [DEBUG] responseData structure for billing: {
  hasResponseData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 933
}
ğŸ’° [BILLING-DIFY_GENERIC] Multi-node LLM: 933 tokens
ğŸ’° [COST-DIFY_GENERIC] Actual cost: $0.002040 = 21 points
ğŸ”„ Using existing user ID mapping for: test-user-999
âš ï¸  [BILLING-DIFY_GENERIC] User not found in database: 7057c440-84a5-412f-a71e-86d94fdc94c3
âŒ [BILLING-DIFY_GENERIC] Failed to create user: null value in column "name" of relation "users" violates not-null constraint
âŒ [BILLING-DIFY_GENERIC] Insert error details: {
  code: '23502',
  details: 'Failing row contains (7057c440-84a5-412f-a71e-86d94fdc94c3, null, null, null, user, 9979, 2025-08-30 06:11:48.847+00).',
  hint: null,
  message: 'null value in column "name" of relation "users" violates not-null constraint'
}
âŒ [BILLING-DIFY_GENERIC] User creation and retry both failed
